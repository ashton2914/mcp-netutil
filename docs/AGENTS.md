# Agent Guide for mcp-netutil

This repository contains a Go-based implementation of a Model Context Protocol (MCP) server that provides network utility tools (traceroute, ping/latency, system stats).

## 1. Build, Lint, and Test Commands

Use standard Go tooling. The project supports cross-compilation via `build.sh`.

### Build
- **Local Development Build**:
  ```bash
  go build .
  ```
- **Cross-Platform Release Build**:
  ```bash
  ./build.sh
  ```
  (See `dist/` directory for artifacts)

### Test
- **Run all tests**:
  ```bash
  go test ./...
  ```
- **Run tests for a specific package**:
  ```bash
  go test -v ./pkg/latency
  ```
- **Run a single test function**:
  ```bash
  # Syntax: go test -v [package_path] -run [TestName]
  go test -v ./pkg/latency -run TestParsePingOutput
  ```
- **Run tests with race detection**:
  ```bash
  go test -race ./...
  ```

### Lint / Verify
- **Standard Go Vet**:
  ```bash
  go vet ./...
  ```
- **Format Check**:
  ```bash
  # Ensure code is formatted
  go fmt ./...
  ```

## 2. Code Style & Conventions

Follow idiomatic Go conventions (Effective Go).

### Formatting & Layout
- **Tooling**: Always run `go fmt` before committing.
- **Indentation**: Use tabs (standard Go behavior).
- **Line Length**: Keep lines reasonably short, but don't strictly wrap at 80 chars if it hurts readability.
- **Grouping**: Group imports into standard library, third-party, and local packages.

### Naming Conventions
- **Case**: Use `PascalCase` for exported identifiers and `camelCase` for internal ones.
- **Acronyms**: Keep acronyms consistent case (e.g., `serveHTTP`, `JSONRPCRequest`, `sessionID`, `ID`).
- **Files**: Use `snake_case` (e.g., `latency_test.go`).
- **Test Functions**: `TestXxx` (e.g., `TestParsePingOutput`).

### Types & Structs
- **JSON Tags**: API structures (MCP messages, RPC) must have `json` tags.
  ```go
  type Tool struct {
      Name        string `json:"name"`
      Description string `json:"description"`
  }
  ```
- **Composition**: Use struct composition where appropriate.

### Error Handling
- **Wrapping**: Use `fmt.Errorf("context: %w", err)` to wrap errors.
- **Checks**: Handle errors explicitly. `if err != nil { return ... }`.
- **Return Values**: Prefer returning `(ResultType, error)` pattern.

### Concurrency & Context
- **Context**: Pass `context.Context` as the first argument to functions that involve I/O or long-running operations (e.g., `latency.Run(ctx, ...)`).
- **Cancellation**: Respect `ctx.Done()` in loops or long operations.
- **Synchronization**: Use `sync.RWMutex` for shared state (like the `sessions` map in `main.go`).
- **Channels**: Use channels for communicating between SSE handlers and background workers.

### Testing
- **Pattern**: Use **Table-Driven Tests** for logic with multiple input/output permutations.
  ```go
  func TestSomething(t *testing.T) {
      tests := []struct {
          name     string
          input    string
          expected string
          wantErr  bool
      }{
          {"Case 1", "in", "out", false},
      }
      for _, tt := range tests {
          t.Run(tt.name, func(t *testing.T) { ... })
      }
  }
  ```
- **Assertions**: Use standard `if got != want { t.Errorf(...) }`. No 3rd party assertion libraries are currently in use (keep it simple).

### Package Structure
- **Root**: `main.go` contains the server entry point and HTTP/MCP wiring.
- **pkg/**: Domain logic resides here.
  - `pkg/latency`: Ping wrapper and parsing logic.
  - `pkg/traceroute`: Traceroute execution.
  - `pkg/system`: System statistics.
  - `pkg/cache`: SQLite database interactions.

### Dependencies
- **Management**: Use `go modules`.
- **CGO**: Disabled by default (`CGO_ENABLED=0`) for builds to ensure static linking, except where `modernc.org/sqlite` is involved (which is a CGO-free port, compatible with `CGO_ENABLED=0`).

### Logging
- **Output**: Logs go to `stderr` (`log.SetOutput(os.Stderr)`).
- **Format**: Standard `log` package (timestamp included by default).

---
*Generated by opencode*
